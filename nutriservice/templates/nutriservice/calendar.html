{% extends "base_generic.html" %}

{% block navbar %}
  <button id="authorize_button" class="btn btn-primary float-right" style="display: block;">Autorizar conta Google</button>
  <button id="signout_button" class="btn btn-primary float-right" style="display: none;">Alterar conta Google</button>
{% endblock %}

{% block content %}
  <iframe id="calendar" src="" width="100%" height="600" frameborder="0" scrolling="no"></iframe>
{% endblock %}

{% block scripts %}
  <script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '177217773425-ktoaf0un3hgni6ud1sf3ih4cb2agd1e9.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyD9HgSmymaLu43wOmr6ImG-il2tUnMFpf0';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/calendar";

    var authorizeButton = document.getElementById('authorize_button');
    var signoutButton = document.getElementById('signout_button');
    var calendar = document.getElementById('calendar');
    
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }
    
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      }, function(error) {
        appendPre(JSON.stringify(error, null, 2));
      });
    }
    
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        //listUpcomingEvents();
        execute();
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }
    
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
      calendar.src = calendar.src;
    }

    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
      calendar.src = '';
    }

    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }

    function listUpcomingEvents() {
      gapi.client.calendar.events.list({
        'calendarId': 'primary',
        'timeMin': (new Date()).toISOString(),
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 10,
        'orderBy': 'startTime'
      }).then(function(response) {
        var events = response.result.items;
        appendPre('Upcoming events:');

        if (events.length > 0) {
          for (i = 0; i < events.length; i++) {
            var event = events[i];
            var when = event.start.dateTime;
            if (!when) {
              when = event.start.date;
            }
            appendPre(event.summary + ' (' + when + ')')
            //console.log(event);
          }
        } else {
          appendPre('No upcoming events found.');
        }
      });
    }
    
    function execute() {
      return gapi.client.calendar.calendarList.list({})
        .then(function(response) {
          for (var calendar of response.result.items) {
            if (calendar.summary === 'nutricenas') {
              return calendar.id;
            }
          }
          throw 'Calendar not found.';
        })
        .catch(function(error) {
          return gapi.client.calendar.calendars.insert({
            "resource": {
              "summary": "nutricenas"
            }
          }).then(function(response) {
            return response.result.id;
          })
          .catch(function(response) {
            throw 'Failed to create calendar.';
          });
        })
        .then(function(id) {
          console.log(id);
          calendar.src = 'https://calendar.google.com/calendar/embed?height=600&amp;wkst=1&amp;bgcolor=%23ffffff&amp;ctz=Europe%2FLisbon&amp;src=' + encodeURIComponent(id) + '&amp;color=%237CB342&amp;color=%23E67C73&amp;color=%2333B679&amp;color=%23137333&amp;color=%23D50000&amp;color=%230B8043&amp;color=%23174ea6&amp;showTitle=0&amp;showNav=1&amp;showDate=1&amp;showTabs=1&amp;showPrint=0&amp;showCalendars=1&amp;mode=WEEK&amp;hl=pt_PT';
        });
    }

  </script>
  <script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
{% endblock %}
